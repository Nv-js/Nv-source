
Nv.add("./compress/1.0.1/cdn_index",function(nv,$){var defaults={ratio:4000000,bgColor:"#fff",piece:1000000,fillColor:"#fff",compressType:"image/jpeg",compressRadio:0.4,compressResult:"base64",compressSuccess:function(data){},uploadFlag:true,uploadBase64Name:"base64str",uploadOptions:{}}
function dataURItoBlob(dataURI){var byteString=atob(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ab=new ArrayBuffer(byteString.length);var ia=new Uint8Array(ab);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i);}
return new Blob([ab],{type:mimeString});}
var uploadImage={filereader:function(base64){var img=new Image(),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),tCanvas=document.createElement("canvas"),tCtx=tCanvas.getContext("2d");var file="";if(!base64){var _files=this.files,_this=this;if(!_files.length){return false;}
var files=[].slice.call(_files);var size=_files[0].size,type=files[0].type;if(!/\/(?:jpeg|png|gif|jpg)/i.test(type)){alert("图片类型不正确");return false;}
file=files[0];}else{file=dataURItoBlob(base64);}
var reader=new FileReader();reader.onload=function(event){var result=this.result;img=new Image();img.src=result;var kbSize=size/1000;if(kbSize<=200){img=null;uploadImage.uploadBase64(result);return;}
if(img.complete){callback()}else{img.onload=callback;}
function callback(){if(defaults.compressResult=="base64"){var data=uploadImage.compress(img,size,canvas,tCanvas,ctx,tCtx);defaults.compressSuccess(data);if(defaults.uploadFlag){uploadImage.uploadBase64(data);}
img=null;}else{uploadImage.compress(img,size,canvas,tCanvas,ctx,tCtx);img=null;}}}
reader.readAsDataURL(file);},compress:function(img,size,canvas,tCanvas,ctx,tCtx){var _initSize=size,_width=parseInt(img.width),_height=parseInt(img.height);var ratio=(_width*_height)/defaults.ratio;if(ratio>1){ratio=ratio*20;}else{ratio=1;}
ratio=Math.sqrt(ratio);var width=_width/ratio,height=_height/ratio;canvas.width=width;canvas.height=height;ctx.fillStyle=defaults.bgColor;ctx.fillRect(0,0,width,height);if(defaults.compressResult=="base64"){var piece=width*height/defaults.piece;if(piece>1){piece=~~(Math.sqrt(piece)+1);piece+=10;var nw=parseFloat(width/piece),nh=parseFloat(height/piece);tCanvas.width=width,tCanvas.height=nh;tCtx.fillStyle=defaults.fillColor;tCtx.fillRect(0,0,width,nh);for(var i=0;i<piece;i++){tCtx.drawImage(img,0,i*nh,width,nh,0,0,width,nh);ctx.drawImage(tCanvas,0,i*nh,width,nh);}}else{ctx.drawImage(img,0,0,width,height);}
var data=canvas.toDataURL(defaults.compressType,defaults.compressRadio);canvas.width=canvas.height=0;return data}else{canvas.toBlob(function(blob){defaults.compressSuccess(blob);if(defaults.uploadFlag){uploadImage.uploadBase64(blob);}},defaults.compressType,defaults.compressRadio);}},uploadBase64:function(result){var _o={data:{}};_o.data[defaults.uploadBase64Name]=result;var options=$.extend(true,_o,defaults.uploadOptions);$.ajax(options);}}
return{config(options){defaults=$.extend(true,defaults,options);},initSelector(inputSelector){$(inputSelector).off("change").on("change",uploadImage.filereader);},initImg(imgSrc){uploadImage.filereader(imgSrc);}}},{requires:["jquery"],alias:'compress'})